{% extends 'base.html.twig' %}

{% block title %}Chat avec {{ receiver.getFullName() }}{% endblock %}

{% block body %}
<div class="container my-5">
    <h2 class="mb-4">Chat avec {{ receiver.getFullName() }}</h2>

    <div id="messages-container" class="border rounded p-3 mb-4" style="height: 300px; overflow-y: auto;">
        {# Rendu initial (fallback au cas où Mercure ne marche pas) #}
        {% include 'chat/_messages.html.twig' %}
    </div>

    <div>
        <input type="hidden" id="receiver-id" value="{{ receiver.id }}">
        <input type="hidden" id="current-user-id" value="{{ app.user.id }}">
        {{ form_start(form, { attr: { class: 'mb-3', id: 'chat-form' } }) }}
            <div class="mb-3">
                {{ form_widget(form.content, {
                    attr: { class: 'form-control', placeholder: 'Écrivez votre message ici...' }
                }) }}
            </div>
            <button type="submit" id="send-message" class="btn btn-outline-primary">
                <i class="bi bi-send-fill me-1"></i> Envoyer
            </button>
        {{ form_end(form) }}
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/@mercure/client"></script>
<script>
    $(document).ready(function () {
        const userId = $('#current-user-id').val();
        const receiverId = $('#receiver-id').val();

        // Envoi du message en AJAX
        $('#send-message').click(function (e) {
            e.preventDefault();
            const content = $('#message_form_content').val().trim();
            if (!content) return;

            $.ajax({
                url: '/chat/send',
                method: 'POST',
                data: {
                    content: content,
                    receiver: receiverId
                },
                success: function () {
                    $('#message_form_content').val('');
                },
                error: function () {
                    alert('Erreur lors de l\'envoi du message');
                }
            });
        });

        // Abonnement Mercure
        const url = new URL('http://localhost:3001/.well-known/mercure');
        const topic = `chat/${Math.min(userId, receiverId)}/${Math.max(userId, receiverId)}`;
        url.searchParams.append('topic', topic);

        const eventSource = new EventSource(url);

        eventSource.onmessage = function (event) {
            const data = JSON.parse(event.data);
            const msg = data.message;
            if (!msg || msg.chatId !== undefined && msg.chatId != receiverId) return;

            const isCurrentUser = msg.userId == userId;

            const container = document.getElementById('messages-container');
            const messageElement = document.createElement('div');
            messageElement.className = isCurrentUser ? 'text-end mb-2' : 'text-start mb-2';
            messageElement.innerHTML = `
                <div class="d-inline-block p-2 rounded ${isCurrentUser ? 'bg-primary text-white' : 'bg-light text-dark'}">
                    <strong>${msg.username}</strong><br>
                    ${msg.content}
                </div>
            `;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        };
    });
</script>
{% endblock %}
